<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js webgl - orbit controls</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style>
		body {
			color: #000;
			font-family: Monospace;
			font-size: 13px;
			text-align: center;
			font-weight: bold;

			background-color: #fff;
			margin: 0px;
			overflow: hidden;
		}

		#info {
			color: #000;
			position: absolute;
			top: 0px;
			width: 100%;
			padding: 5px;

		}

		a {
			color: red;
		}
	</style>
</head>

<body>
	<div id="info">
		<a href="http://threejs.org" target="_blank" rel="noopener">three.js</a> - orbit controls example
	</div>
	<script src="http://chaijs.com/chai.js" type="text/javascript"></script>
	<script src="http://threejs.org/build/three.min.js"></script>
	<script src="js/controls/PlanetControls.js"></script>
	<script src="js/mesh/EarthTiles.js"></script>
	<script src="js/tiler/BasicTiler.js"></script>

	<!-- <script src="js/Detector.js"></script> -->

	<script>

		// if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

		var radius = 6371;
		var tiler;
		var camera, controls, scene, renderer, cameraSurvey;
		var R = 6400;


		// var tiles = [
		// 	{z: 1, x: 0, y: 0},
		// 	{z: 1, x: 1, y: 0},
		// 	{z: 1, x: 0, y: 1},
		// 	{z: 1, x: 1, y: 1}
		// ];
		// var tiles = [];
		var tiles = [
			{ z: 2, x: 0, y: 0 },
			{ z: 2, x: 1, y: 0 },
			{ z: 2, x: 2, y: 0 },
			{ z: 2, x: 3, y: 0 },
			{ z: 2, x: 0, y: 1 },
			{ z: 2, x: 1, y: 1 },
			{ z: 2, x: 2, y: 1 },
			{ z: 2, x: 3, y: 1 },
			{ z: 2, x: 0, y: 2 },
			{ z: 2, x: 1, y: 2 },
			{ z: 2, x: 2, y: 2 },
			{ z: 2, x: 3, y: 2 },
			{ z: 2, x: 0, y: 3 },
			{ z: 2, x: 1, y: 3 },
			{ z: 2, x: 2, y: 3 },
			{ z: 2, x: 3, y: 3 }
		];
		test();
		init();
		render(); // remove when using next line for animation loop (requestAnimationFrame)
		move();

		//animate();

		function test() {
			THREE.BasicTiler.test();
		}
		function init() {
			tiler = new THREE.BasicTiler();
			scene = new THREE.Scene();
			scene.background = new THREE.Color(0xcccccc);
			scene.fog = new THREE.FogExp2(0xcccccc, 0.00002);

			renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 100000);
			cameraSurvey = new THREE.Object3D();

			// camera.position.setFromSpherical(THREE.Spherical(radius * 5, 0, 0));
			// camera.quaternion.y = Math.PI/4;
			// camera.quaternion.z = Math.PI/4;
			// camera.position.setFromSpherical(THREE.Spherical(radius * 1.8, 0, 0));
			console.log('camera.position:', camera.position);

			scene.add(cameraSurvey);

			// controls
			controls = new THREE.PlanetControls(camera, renderer.domElement, cameraSurvey);
			// controls = new THREE.OrbitControls( camera, renderer.domElement, target );
			// controls.maxPolarAngle = 24 * Math.PI / 48; // radians
			controls.addEventListener('change', render);

			controls.minDistance = 100;
			controls.maxDistance = radius * 4;

			controls.maxPolarAngle = Math.PI / 2;

		    // // Longitude
			// controls.minLongitudePlanet = 0; // radians
			// controls.maxLongitudePlanet = Math.PI; // radians
    		// // Latitude
			// controls.minLatitudePlanet = - Math.PI/2; // radians
			// controls.maxLatitudePlanet = + Math.PI/2; // radians

			// world

			earth = new THREE.Object3D();
			scene.add(earth);
			earthTiles = new THREE.EarthTiles(render);
			earthTiles.tiles = ['http://localhost:2016/{z}/{x}/{y}.jpg'];
			earth.add(earthTiles.getObject());
			// earthTiles.update(tiles);


			// textureLoader = new THREE.TextureLoader();

			// textureLoader.load(
			// 	'textures/planets/earth_atmos_4096.jpg',
			// 	function( tex ) {
			// 		var geometry = new THREE.SphereBufferGeometry( radius, 100, 50 );
			// 		var material = new THREE.MeshPhongMaterial( {
			// 			map: tex,
			// 			color: 0xffffff,
			// 			shininess: 200,
			// 			needsUpdate: true
			// 		} );
			// 		var mesh = new THREE.Mesh( geometry, material );
			// 		mesh.position.set( 0, 0, 0 );
			// 		scene.add( mesh );
			// 		render();
			// 	}
			// );

			// // target axes
			// var axesCenter = new THREE.AxesHelper(2000);
			// axesCenter.position.set( 0, 0, 0 );
			// scene.add(axesCenter);

			// // target axes
			// axes = new THREE.AxesHelper(2000);
			// axes.position.set( 0, 0, 0 );
			// scene.add(axes);

			// lights

			var light = new THREE.DirectionalLight(0xffffff);
			light.position.set(1, 1, 1);
			scene.add(light);

			var light = new THREE.DirectionalLight(0x002288);
			light.position.set(-1, -1, -1);
			scene.add(light);

			var light = new THREE.AmbientLight(0x222222);
			scene.add(light);

			window.addEventListener('resize', onWindowResize, false);

		}

		function move() {
			var z, x, y;
			// var position = {
			// 	altitude: radius * 4,
			// 	lon: 0,
			// 	lat: Math.PI / 4,
			// 	theta: 0,
			// 	phi: Math.PI / 4
			// };
			// var position = {
			// 	alt: radius * 4,
			// 	lon: Math.PI/32,
			// 	lat: Math.PI/32,
			// 	theta: 0,
			// 	phi: 0
			// };
			// var position = {
			// 	alt: 12597.488437942575,
			// 	lon: 0.01600890043963752,
			// 	lat: 0.6790204737589939,
			// 	theta: 0,
			// 	phi: 0
			// };
			// };
			var position = {
				alt: 12742,
				lon: 0.6863364576566329,
				lat: 0.32783806761943424,
				theta: 0,
				phi: 0
			};

			console.log('position:', position.alt, position.lon * 180 / Math.PI, position.lat * 180 / Math.PI);
			controls.move(position);
			var tiles = tiler.getTiles(position);
			// tiles = [{
            //         z: 3,
            //         x: 4,
            //         y: 2
            // }];

			console.log('tiles:', tiles);
			earthTiles.update(tiles);
			var i = 0;
			while (i<50000) {
				(function (i) {
					var limits;
					var position;
					setTimeout(function () {
						limits = {
							alt: {min: radius / 2, max: 4 * radius},
							lon: {min:0, max: Math.PI},
							lat: {min: - Math.PI/2, max: Math.PI/2}
						}
						position = {
							alt: limits.alt.min + Math.random() * (limits.alt.max - limits.alt.min),
							lon: limits.lon.min + Math.random() * (limits.lon.max - limits.lon.min),
							lat: limits.lat.min + Math.random() * (limits.lat.max - limits.lat.min),
							theta: 0,
							phi: 0
						};
						console.log('position:', position);
						controls.move(position);
						var tiles = tiler.getTiles(position);
						console.log('tiles:', tiles);
						earthTiles.update(tiles);
					}, 100 * i);
				})(i++)
			}
		}
		function onWindowResize() {

			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();

			renderer.setSize(window.innerWidth, window.innerHeight);

		}

		function animate() {

			requestAnimationFrame(animate);

			controls.update(); // only required if controls.enableDamping = true, or if controls.autoRotate = true

			render();

		}

		function render() {

			// renderer.render( scene, camera );
			renderer.render(scene, camera);

			// if (typeof axes !== "undefined") {
			// 	// axes.position.set(controls.target);
			// 	axes.position.setX( controls.target.x );
			// 	axes.position.setY( controls.target.y );
			// 	axes.position.setZ( controls.target.z );
			// 	// axes.rotation.x = controls.targetS.phi;
			// 	// axes.rotation.y = controls.targetS.theta;
			// 	// axes.rotation.x = controls.targetS.phi;
			// 	// axes.rotation.set( controls.targetS.theta );
			// }

		}

	</script>

</body>

</html>